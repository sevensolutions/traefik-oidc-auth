http:
  services:
    whoami:
      loadBalancer:
        servers:
          - url: http://whoami:80

  middlewares:
    oidc-auth:
      plugin:
        traefik-oidc-auth:
          LogLevel: DEBUG
          Secret: "MLFs4TT99kOOq8h3UAVRtYoCTDYXiRcZ" # Please change this secret for your setup
          Provider:
            UrlEnv: "PROVIDER_URL"
            ClientIdEnv: "CLIENT_ID"
            ClientSecretEnv: "CLIENT_SECRET"
            UsePkce: true
          Scopes: ["openid", "profile", "email"]
          Headers:
            - Name: "X-Oidc-Username"
              Value: "{{`{{ .claims.preferred_username }}`}}"
            - Name: "X-Oidc-Subject"
              Value: "sub"
            - Name: "Authorization"
              Value: "{{`Bearer {{ .accessToken }}`}}"
          AuthorizationHeader:
            Name: "CustomAuth"
          AuthorizationCookie:
            Name: "CustomAuth"
          BypassAuthenticationRule: "Header(`cache-control`, `no-cache`) || HeaderRegexp(`X-Real-Ip`, `^172\\.18\\.`)"
          #UnauthorizedBehavior: "Unauthorized"
          # Authorization:
          #   AssertClaims:
          #     - Name: roles
          #       AnyOf: ["admin", "media"]
          #     - Name: some.nested.key
          #       AnyOf: ["some value"]
          # If set, only the /login endpoint will initiate the login flow
          #LoginUri: "/login"
          #PostLoginRedirectUri: "/"

  routers:
    whoami:
      entryPoints: ["web"]
      rule: "HostRegexp(`.+`)"
      service: whoami
      middlewares: ["oidc-auth@file"]
